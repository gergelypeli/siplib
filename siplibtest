#! /usr/bin/python

from __future__ import print_function, unicode_literals
from pprint import pprint
import weakref
from datetime import timedelta
import logging

from async import Metapoll, WeakMethod

from format import Addr, Uri, Nameaddr, Status, Via, print_structured_message, parse_structured_message
from transactions import TransactionManager, make_virtual_response
from dialog import Dialog, DialogManager

local_addr = Addr("localhost", 5060)

#caller_addr = Addr("CALLER", 5060)
caller_uri = Uri(local_addr, "caller")
caller_nameaddr = Nameaddr(caller_uri, "Caller")

#callee_addr = Addr("CALLEE", 5060)
callee_uri = Uri(local_addr, "callee")
callee_nameaddr = Nameaddr(callee_uri, "Callee")


class DummyCallee(Dialog):
    def handle_request(self, msg):
        method = msg["method"]
        print("DummyCallee received: %s" % method)
        #pprint(msg)
        
        if method == "INVITE":
            self.invite_msg = msg
            self.take_request(msg)
            self.trying()
        elif method == "ACK":
            virtual_response = make_virtual_response()
            self.send_response(virtual_response, msg)
            self.send_response(virtual_response, self.invite_msg)
        
        
    def sleep(self, secs, method):
        metapoll.register_timeout(timedelta(seconds=secs), WeakMethod(method))
        
        
    def trying(self):
        self.send_response(dict(status=Status(100, "Trying")), self.invite_msg)
        self.sleep(1, self.ringing)
        
        
    def ringing(self):
        self.send_response(dict(status=Status(180, "Ringing")), self.invite_msg)
        self.sleep(1, self.answering)


    def answering(self):
        self.send_response(dict(status=Status(200, "OK")), self.invite_msg)


class TestDialogManager(DialogManager):
    def testing(self):
        print("Testing begins.")
        wself = weakref.proxy(self)
        self.caller = DummyCallee(wself, caller_uri, caller_nameaddr.name, callee_uri)
        self.add_dialog(self.caller)
        
        req_params = dict(method="INVITE")
        report = WeakMethod(self.invite_responded)
        self.caller.send_request(req_params, None, report=report)
        
        
    def invite_responded(self, response):
        code = response["status"].code
        print("Invite responded with %d" % code)
        
        if code >= 200:
            req_params = dict(method="ACK")
            report = WeakMethod(self.invite_responded)
            self.caller.send_request(req_params, response, report=report)
        

    def auth_invite(self, uri):
        print("Authing callee: %s" % str(uri))
        wself = weakref.proxy(self)
        callee = DummyCallee(wself, callee_uri, callee_nameaddr.name)
        return callee
        

class Transport(object):
    def __init__(self, reception):
        self.reception = reception
        
    def get_addr(self):
        return local_addr

    def send(self, msg):
        sip = print_structured_message(msg)
        print("Transport sending:")
        print(sip)
        
        metapoll.register_timeout(timedelta(), WeakMethod(self.recved, sip))
        #self.recved(sip)

    def recved(self, sip):
        print("Transport receiving:")
        #print(s)
        self.reception(parse_structured_message(sip))


def reception(params):
    print("Got message from transport.")
    #print("Req params: %s" % req_params)
    matched = transaction_manager.match_incoming_message(params)
    
    if not matched:
        report = dialog_manager.handle_incoming_message(params)
        
        if report:
            transaction_manager.create_incoming_request(params, report)
        else:
            raise Exception("Couldn't create dialog!")


def to_transport(msg):
    print("Sending message by transport.")
    transport.send(msg)


def to_transaction(msg, related_msg, report):
    print("Sending message by transaction.")
    transaction_manager.send_message(msg, related_msg, report)


logging.basicConfig(level=logging.DEBUG)
metapoll = Metapoll()
transport = Transport(reception)
transaction_manager = TransactionManager(to_transport, local_addr)
dialog_manager = TestDialogManager(to_transaction)

metapoll.register_timeout(timedelta(seconds=0.2), WeakMethod(transaction_manager.maintenance), repeat=True)
metapoll.register_timeout(timedelta(seconds=1), WeakMethod(dialog_manager.testing))

while True:
    #print("Polling.")
    metapoll.do_poll()
