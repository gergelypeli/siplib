#! /usr/bin/python

from __future__ import print_function, unicode_literals
from pprint import pprint
from weakref import proxy as Weak
from datetime import timedelta, datetime
import logging

from async import Metapoll, WeakMethod

from format import Addr, Uri, Nameaddr, Status, Via, Hop, print_structured_message, parse_structured_message
from transactions import TransactionManager, make_virtual_response, make_simple_response
from dialog import Dialog, DialogManager
from leg import Leg, SipLeg, create_uninvited_leg
from call import Call
from sdp import Sdp
from authority import Authority
from registrar import RegistrationManager, RecordManager

#local_addr = Addr("localhost", 5060)
a_addr = Addr("a.net", 5060)
b_addr = Addr("b.net", 5060)

a_registrar = Uri(a_addr)

caller_uri = Uri(a_addr, "caller")
caller_name = "Caller"
caller_nameaddr = Nameaddr(caller_uri, caller_name)

callee_uri = Uri(b_addr, "callee")
callee_name = "Callee"
callee_nameaddr = Nameaddr(callee_uri, callee_name)

#wrong_uri = Uri(local_addr, "wrong")

caller_cred = ("CALLER_AUTHNAME", "CALLER_HA1")
callee_cred = ("CALLEE_AUTHNAME", "CALLEE_HA1")

caller_audio_addr = ("localhost", 10000)
caller_video_addr = ("localhost", 10001)

caller_sdp = Sdp.parse("""
v=0
o=jdoe 2890844526 2890842807 IN IP4 10.47.16.5
s=SDP Seminar
i=A Seminar on the session description protocol
u=http://www.example.com/seminars/sdp.pdf
e=j.doe@example.com (Jane Doe)
c=IN IP4 224.2.17.12
t=2873397496 2873404696
a=recvonly
m=audio 49170 RTP/AVP 0
m=video 51372 RTP/AVP 99
a=rtpmap:99 h263-1998/90000
""")

mgw_addr = ("localhost", 20000)


def sleep(secs, method):
    metapoll.register_timeout(timedelta(seconds=secs), WeakMethod(method))


class CalleeLeg(Leg):
    def __init__(self):
        super(CalleeLeg, self).__init__()
        
        #self.rtp_socket = socket.socket()
        
    def do(self, action):
        if action["type"] == "dial":
            self.offer = action.get("offer")
            print("Got offer:\n%s" % repr(self.offer))
            sleep(1, self.ringing)
        elif action["type"] == "hangup":
            print("The caller hung up.")

        
    def ringing(self):
        self.report(dict(type="ring"))
        sleep(1, self.answering)


    def answering(self):
        answer = self.make_answer(self.offer)
        self.report(dict(type="accept", answer=answer))
        sleep(1, self.hanging)
        
        
    def hanging(self):
        self.report(dict(type="hangup"))


    def make_answer(self, offer):
        return offer


class CallerLeg(Leg):
    def dial(self):
        self.ctx["from"] = Nameaddr(caller_uri, caller_name)
        self.ctx["to"] = Nameaddr(callee_uri)
        self.report(dict(type="dial", ctx=self.ctx, offer=caller_sdp))
        #self.sleep(3, self.hanging)


    def do(self, action):
        if action["type"] == "accept":
            print("Accepted with SDP:\n%s" % repr(action.get("answer")))
            #self.sleep(1, self.hanging)

            
    def hanging(self):
        self.leg.do(dict(type="hangup"))


class Transport(object):
    def __init__(self, local_addr, reception):
        self.reception = reception
        self.transmission = None
        self.hop = Hop(local_addr=local_addr, remote_addr=None, iface="virt")
        
        
    def set_peer(self, peer):
        self.transmission = WeakMethod(peer.process)
        self.hop = Hop(local_addr=self.hop.local_addr, remote_addr=peer.hop.local_addr, iface=self.hop.iface)
        
        
    def get_hop(self, uri):
        # FIXME: cheating!
        #return Hop(local_addr=("a", 10000), remote_addr=("b", 20000), iface="eth0")
        return self.hop
        
        
    def send(self, msg):
        if msg["hop"] != self.hop:
            print("This transport can't send this!")
            return
        
        sip = print_structured_message(msg)
        print("Transport sending by %s:" % (self.hop,))
        print("\n" + "\n".join("  %s" % line for line in sip.split("\n")))
        
        #poh = Hop(local_addr=hop.remote_addr, remote_addr=hop.local_addr, iface=hop.iface)
        metapoll.register_timeout(timedelta(), self.transmission.rebind(sip))


    def process(self, sip):
        #print("Transport receiving:")
        #print(s)
        msg = parse_structured_message(sip)
        msg["hop"] = self.hop
        self.reception(msg)


class TestAuthority(Authority):
    def __init__(self, realm, record_manager):
        super(TestAuthority, self).__init__(realm)
        
        self.record_manager = record_manager
        self.users = {}
        self.myuser = None
        
        
    def adduser(self, authname, ha1):
        self.users[authname] = ha1
        
        
    def setuser(self, authname, ha1):
        self.myuser = (authname, ha1)
        

    def authenticate(self, params):
        method = params["method"]
        from_uri = params["from"].uri
        hop = params["hop"]
        
        if method != "REGISTER" and hop in self.record_manager.lookup_contact_hops(from_uri):
            print("Trusting registered user '%s'" % (from_uri,))
            return True
        
        authname = self.get_digest_authname(params)
        if authname in self.users:
            return self.check_digest_ha1(params, self.users[authname])
            
        return False
            
            
    def identify(self, params):
        return self.myuser
        

class Switch(object):
    def __init__(self, metapoll, local_addr, realm):
        self.metapoll = metapoll
        self.transport = Transport(local_addr, WeakMethod(self.reception))
        self.transaction_manager = TransactionManager(local_addr, WeakMethod(self.transport.send))
        self.record_manager = RecordManager(WeakMethod(self.transaction_manager.send_message))
        self.authority = TestAuthority(realm, Weak(self.record_manager))  # TODO: domain2realm!
        self.registration_manager = RegistrationManager(
            WeakMethod(self.transaction_manager.send_message),
            WeakMethod(self.transport.get_hop),
            WeakMethod(self.authority.provide_auth)
        )
        self.dialog_manager = DialogManager(
            local_addr,
            WeakMethod(self.transaction_manager.send_message),
            WeakMethod(self.transport.get_hop),
            WeakMethod(self.authority.provide_auth)
        )

        metapoll.register_timeout(timedelta(seconds=0.2), WeakMethod(self.transaction_manager.maintenance), repeat=True)

    
    def reject_request(self, msg, status):
        if msg:
            response = make_simple_response(msg, status)
            self.transaction_manager.send_message(response, msg)


    def challenge_request(self, msg, challenge):
        if msg:
            response = make_simple_response(msg, Status(401, "Hey"), challenge)
            self.transaction_manager.send_message(response, msg)


    def route_to_registered_sip_contact(self, ctx):
        to_uri = ctx["to"].uri
        print("Checking registered SIP contact: %s" % (to_uri,))
        contacts = self.record_manager.lookup_contact_uris(to_uri)
            
        if contacts:
            ctx["to"] = Nameaddr(contacts[0])
            outgoing_dialog = Dialog(Weak(self.dialog_manager))
            outgoing_leg = SipLeg(outgoing_dialog)
            return outgoing_leg
        else:
            print("No such registered SIP contact: %s" % (to_uri,))
            return None
        

    def route(self, ctx):
        return self.route_to_registered_sip_contact(ctx)
        

    def accept_invite(self, params):
        incoming_dialog = Dialog(Weak(self.dialog_manager))
        incoming_leg = SipLeg(incoming_dialog)
        self.call = Call(WeakMethod(self.route))
        self.call.add_leg(0, incoming_leg)
        return WeakMethod(incoming_dialog.recv_request)


    def process_request(self, params):
        if params["uri"].schema != "sip":
            WeakMethod(self.reject_request, Status(404, "Not found"))
            
        challenge = self.authority.require_auth(params)
        if challenge:
            return WeakMethod(self.challenge_request, challenge)

        if params["method"] == "REGISTER":
            return self.record_manager.match_incoming_request(params)

        report = self.dialog_manager.match_incoming_request(params)
        if report:
            return report
    
        if params["method"] == "INVITE" and "tag" not in params["to"].params:
            return self.accept_invite(params)
    
        return WeakMethod(self.reject_request, Status(400, "Bad request"))
        

    def reception(self, params):
        #print("Got message from transport.")
        #print("Req params: %s" % req_params)
        uninvite_params = self.transaction_manager.match_uninvited_response(params)
        if uninvite_params:
            create_uninvited_leg(uninvite_params)
    
        if self.transaction_manager.match_incoming_message(params):
            return

        report = self.process_request(params)
        
        self.transaction_manager.create_incoming_request(params, report)


class SwitchA(Switch):
    def __init__(self, metapoll, *args):
        super(SwitchA, self).__init__(metapoll, *args)
        
        self.authority.setuser(*caller_cred)
        self.authority.adduser(*callee_cred)

        metapoll.register_timeout(timedelta(seconds=2), WeakMethod(self.test_dialing))
        
        
    def test_dialing(self):
        print("Dialing begins.")

        incoming_leg = CallerLeg()
        self.call = Call(WeakMethod(self.route))
        self.call.add_leg(0, incoming_leg)
        incoming_leg.dial()
    

class SwitchB(Switch):
    def __init__(self, metapoll, *args):
        super(SwitchB, self).__init__(metapoll, *args)
        
        self.authority.setuser(*callee_cred)
        self.authority.adduser(*caller_cred)

        metapoll.register_timeout(timedelta(seconds=1), WeakMethod(self.test_registering))


    def route(self, ctx):
        to_uri = ctx["to"].uri
        
        if to_uri.user == "callee":
            return CalleeLeg()
            
        return super(SwitchB, self).route(ctx)
        
        
    def test_registering(self):
        print("Registering begins.")

        self.registration_manager.start_registration(a_registrar, callee_uri, callee_uri)
        #sleep(1, self.testing1)
    

logging.basicConfig(level=logging.DEBUG)
metapoll = Metapoll()

mgw = mp.ContextManager(metapoll, mgw_ddr)
mgc = mp.Controller(metapoll, mgw_addr)

switch_a = SwitchA(metapoll, a_addr, "A-NET")
switch_b = SwitchB(metapoll, b_addr, "B-NET")

switch_a.transport.set_peer(switch_b.transport)
switch_b.transport.set_peer(switch_a.transport)

while True:
    try:
        metapoll.do_poll()
    except KeyboardInterrupt:
        break
